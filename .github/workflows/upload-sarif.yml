name: "Upload SARIF"

on:
  workflow_dispatch:
    inputs:
      tests_push:
        description:  Does tests needs to be pushed
        required: true
        type: choice
        options: 
        - yes
        - no
  
env:
  utbot_version: "1.0.1"
    
jobs:
  build:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Download server executable
      run: |
           mkdir utbot-release-${{ env.utbot_version }}
           wget "https://github.com/slawa4s/UTBotCpp/releases/download/v${{ env.utbot_version }}/utbot-release-${{ env.utbot_version }}.zip" -P "${{ github.workspace }}/utbot-release-${{ env.utbot_version }}"
           unzip "${{ github.workspace }}/utbot-release-${{ env.utbot_version }}/utbot-release-${{ env.utbot_version }}.zip" -d "${{ github.workspace }}/utbot-release-${{ env.utbot_version }}/"
           chmod +x "${{ github.workspace }}/utbot-release-${{ env.utbot_version }}/unpack_and_run_utbot.sh"
           cd ${{ github.workspace }}/utbot-release-${{ env.utbot_version }} && ./unpack_and_run_utbot.sh
    - name: Testing project
      run: |       
          cd "${{ github.workspace }}/utbot-release-${{ env.utbot_version }}/utbot_distr"
          export CURRENT_FOLDER="$( cd $( dirname . ) && pwd )"
          RUN_SYSTEM_SCRIPT_PATH=$CURRENT_FOLDER/utbot_run_system.sh
          UTBOT_CLI_OPTIONS="generate --project-path ${{ github.workspace }} project"
          $RUN_SYSTEM_SCRIPT_PATH "cli" $UTBOT_CLI_OPTIONS
    - name: Push into master
      uses: EndBug/add-and-commit@v9
      with:
        add: 'tests saifOutput.sarif'
        author_name: 'github-actions[utbot]'
        message: 'add tests and sarif'
        push: true
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: saifOutput.sarif
    
