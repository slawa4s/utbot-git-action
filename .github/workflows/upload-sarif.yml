name: "UTBot code analysis"

description: "UTBot code analysis allows adding tests and code analysis information by pull request"
branding:
  icon: 'terminal'
  color: 'blue'

on:
  workflow_dispatch:
    inputs:
      test_push_info:
        description: 'Do tests need to be pushed'
        default: true 
        type: boolean
      test_delete_info:
        description: 'Do old tests need to be deleted'
        default: false
        type: boolean
  
env:
  utbot_version: "1.0.1"
  repository_name: "olezhabobrov"
    
jobs:
  build:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Delete old tests
      if: github.event.inputs.test_delete_info == 'true'
      uses: EndBug/add-and-commit@v9
      with:
        remove: 'tests'
        author_name: 'github-actions[utbot]'
        message: 'UTBot code analysis delete old tests'
        
    - name: Download server executable
      run: |
           mkdir "utbot-release-${{ env.utbot_version }}"
           wget "https://github.com/${{ env.repository_name }}/UTBotCpp/releases/download/v${{ env.utbot_version }}/utbot-release-${{ env.utbot_version }}.zip" -P "./utbot-release-${{ env.utbot_version }}"
           unzip "./utbot-release-${{ env.utbot_version }}/utbot-release-${{ env.utbot_version }}.zip" -d "./utbot-release-${{ env.utbot_version }}/"
           chmod +x "./utbot-release-${{ env.utbot_version }}/unpack_and_run_utbot.sh"
           cd "./utbot-release-${{ env.utbot_version }}" && ./unpack_and_run_utbot.sh
           
    - name: Testing project
      run: |       
          cd "./utbot-release-${{ env.utbot_version }}/utbot_distr"
          export CURRENT_FOLDER="$( cd $( dirname . ) && pwd )"
          RUN_SYSTEM_SCRIPT_PATH=$CURRENT_FOLDER/utbot_run_system.sh
          UTBOT_CLI_OPTIONS="generate --project-path ../.. project"
          $RUN_SYSTEM_SCRIPT_PATH "cli" $UTBOT_CLI_OPTIONS
          
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: codeAnalysis/project_code_analysis.sarif
        
    - name: Create Pull Request with tests and codeAnalysis information
      if: github.event.inputs.test_push_info == 'true'
      uses: peter-evans/create-pull-request@v4
      with:
        add-paths: |
            tests/
            codeAnalysis/
        commit-message: UTBot code analysis add tests and codeAnalysis information
        branch-suffix: timestamp
        branch: utbote-code-analysis
        title: UTBot code analysis
        body: UTBot code analysis add tests and codeAnalysis information
        delete-branch: true
        
    - name: Create Pull Request with codeAnalysis information
      if: github.event.inputs.test_push_info == 'false'
      uses: peter-evans/create-pull-request@v4
      with:
        add-paths: |
            codeAnalysis/
        commit-message: UTBot code analysis add codeAnalysis information
        branch-suffix: timestamp
        branch: utbote-code-analysis
        title: UTBot code analysis
        body: UTBot code analysis add codeAnalysis information
        delete-branch: true
